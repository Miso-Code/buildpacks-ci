package main

import (
	"github.com/Miso-Code/buildpacks-ci/cve-notification-app/common"
	"github.com/Miso-Code/buildpacks-ci/cve-notification-app/core"
	"github.com/Miso-Code/buildpacks-ci/cve-notification-app/services"
	"github.com/jessevdk/go-flags"
	"github.com/rs/zerolog"
	"log"
	"os"
)

func main() {
	logger := zerolog.New(zerolog.ConsoleWriter{Out: os.Stdout}).With().Timestamp().Logger()

	var opts struct {
		DBUri         string `long:"db-uri" description:"Database URI" required:"true"`
		NVDNistApiKey string `long:"nvd-nist-api-key" description:"NVD Nist API Key" required:"true"`
	}

	_, err := flags.Parse(&opts)
	if err != nil {
		log.Fatal(err)
	}

	allUtils := common.LibrariesUtil{
		MongoLibrary:   services.NewMongoLibrary(opts.DBUri),
		NvdNistLibrary: services.NewNVDNistLibrary(opts.NVDNistApiKey),
	}

	err = core.FillDatabase(allUtils)
	if err != nil {
		logger.Error().Err(err).Msg("Error filling database")
	}
}
