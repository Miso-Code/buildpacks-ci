package services

import (
	"encoding/csv"

	"github.com/spf13/afero"
)

//go:generate go run github.com/maxbrunsfeld/counterfeiter/v6 . CSVReaderLibraryInterface
type CSVReaderLibraryInterface interface {
	GetDependenciesList() ([]DepList, error)
}

type CSVReaderLibrary struct {
	FilePath   string
	FileSystem afero.Fs
}

type DepList struct {
	Vendor  string
	Product string
}

func NewCSVReaderLibrary(filePath string) CSVReaderLibrary {
	return CSVReaderLibrary{FilePath: filePath, FileSystem: afero.NewOsFs()}
}

func (csvU CSVReaderLibrary) GetDependenciesList() ([]DepList, error) {
	csvFile, err := csvU.FileSystem.Open(csvU.FilePath)
	if err != nil {
		return nil, err
	}

	reader := csv.NewReader(csvFile)

	if _, err := reader.Read(); err != nil {
		return nil, err
	}

	csvLines, err := reader.ReadAll()
	if err != nil {
		return nil, err
	}

	var deps []DepList

	for _, line := range csvLines {

		if line[1] != "" && line[2] != "" {
			deps = append(deps, DepList{
				Vendor:  line[1],
				Product: line[2],
			})
		}
	}

	return deps, nil
}
