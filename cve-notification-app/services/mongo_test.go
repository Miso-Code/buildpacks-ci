package services_test

import (
	context2 "context"
	"testing"
	"time"

	"github.com/Miso-Code/buildpacks-ci/cve-notification-app/services"
	"github.com/sclevine/spec"
	"github.com/sclevine/spec/report"
	assertpkg "github.com/stretchr/testify/assert"
	requirepkg "github.com/stretchr/testify/require"
	"github.com/tryvium-travels/memongo"
	"github.com/tryvium-travels/memongo/memongolog"
	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
)

func TestMongoLibrary(t *testing.T) {
	spec.Run(t, "Mongo Library", testMongoLibrary, spec.Report(report.Terminal{}))
}

func testMongoLibrary(t *testing.T, context spec.G, it spec.S) {
	var (
		assert       = assertpkg.New(t)
		require      = requirepkg.New(t)
		mongoLibrary services.MongoLibrary
		mongoServer  *memongo.Server
		mClient      *mongo.Client
		ctx          context2.Context
		err          error
	)

	it.Before(func() {
		mongoServer, err = memongo.StartWithOptions(&memongo.Options{
			MongoVersion: "6.0.12",
			LogLevel:     memongolog.LogLevelWarn,
		})
		require.NoError(err)
	})

	it.After(func() {
		mongoServer.Stop()
	})

	context("Calls the GetMongoClient method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())
			})

			it("gets the mongo.Client object and it's ready to perform any operation", func() {
				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)

				err = mClient.Ping(ctx, nil)
				require.NoError(err)
			})
		})

		context("fails", func() {
			context("creating mongo client", func() {
				it.Before(func() {
					mongoLibrary = services.MongoLibrary{
						DbUri: "wrong-uri",
					}
				})

				it("returns an error", func() {
					_, _, err = mongoLibrary.GetMongoClient()
					require.Error(err)

					assert.EqualError(err, "error connecting to MongoDB\nerror parsing uri: scheme must be \"mongodb\" or \"mongodb+srv\"")
				})
			})
		})
	})

	context("Calls the GetMongoCollection method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, _, err = mongoLibrary.GetMongoClient()
				require.NoError(err)
			})

			it("gets the mongo.collection object", func() {
				mongoCollection := mongoLibrary.GetMongoCollection(mClient, "testDb", "test_collection")
				assert.Equal("testDb", mongoCollection.Database().Name())
			})
		})
	})

	context("Calls the DisconnectMongoClient method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)
			})

			it("disconnects the mongo client", func() {
				err = mongoLibrary.DisconnectMongoClient(mClient, ctx)
				require.NoError(err)

				err = mClient.Ping(ctx, nil)
				require.Error(err)

				assert.EqualError(err, "client is disconnected")
			})
		})
	})

	context("Calls the CreateCVE method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)
			})

			it("creates a new CVE in the database", func() {
				cve := services.CVE{
					ID:          primitive.NewObjectID(),
					CreatedAt:   time.Now(),
					UpdatedAt:   time.Now(),
					Vendor:      "TEST",
					Product:     "TEST",
					Severity:    "TEST",
					CVEId:       "TEST",
					Description: "TEST",
				}

				err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
				require.NoError(err)
			})
		})

		context("fails", func() {
			context("creating CVE", func() {
				it.Before(func() {
					mongoLibrary = services.MongoLibrary{
						DbUri:       mongoServer.URI(),
						CtxDuration: 1 * time.Microsecond,
					}

					mClient, ctx, err = mongoLibrary.GetMongoClient()
					require.NoError(err)
				})

				it("return an error when the ctx timeout is exceeded", func() {
					cve := services.CVE{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "TEST",
						Product:     "TEST",
						Severity:    "TEST",
						CVEId:       "TEST",
						Description: "TEST",
					}

					err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
					require.Error(err)

					assert.Contains(err.Error(), "error creating a CVE\nserver selection error: context deadline exceeded")
				})
			})
		})
	})

	context("Calls the GetUniqueDependencies method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)

				cves := []services.CVE{
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "haxx",
						Product:     "curl",
						Severity:    "CRITICAL",
						CVEId:       "TEST",
						Description: "TEST",
					},
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "golang",
						Product:     "go",
						Severity:    "HIGH",
						CVEId:       "TEST2",
						Description: "TEST2",
					},
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "haxx",
						Product:     "curl",
						Severity:    "LOW",
						CVEId:       "TEST3",
						Description: "TEST3",
					},
				}

				for _, cve := range cves {
					err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
					require.NoError(err)
				}
			})

			it("gets the unique dependencies (product) stored in the database", func() {
				uniqueDeps, err := mongoLibrary.GetUniqueDependencies(ctx, mClient)
				assert.NoError(err)

				assert.Equal(2, len(uniqueDeps))
				assert.Equal("curl", uniqueDeps[0].Product)
				assert.Equal("go", uniqueDeps[1].Product)
			})
		})

		context("fails", func() {
			context("getting unique dependencies with ctx timeout is exceeded", func() {
				it.Before(func() {
					mongoLibrary = services.MongoLibrary{
						DbUri:       mongoServer.URI(),
						CtxDuration: 1 * time.Nanosecond,
					}

					mClient, ctx, err = mongoLibrary.GetMongoClient()
					require.NoError(err)
				})

				it("return an error", func() {
					_, err = mongoLibrary.GetUniqueDependencies(ctx, mClient)
					assert.Error(err)

					assert.Contains(err.Error(), "error getting unique CVEs query result\nserver selection error: context deadline exceeded")
				})
			})
		})
	})

	context("Calls the FindCVE method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)

				cve := services.CVE{
					ID:          primitive.NewObjectID(),
					CreatedAt:   time.Now(),
					UpdatedAt:   time.Now(),
					Vendor:      "golang",
					Product:     "go",
					Severity:    "LOW",
					CVEId:       "TEST",
					Description: "TEST",
				}

				err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
				require.NoError(err)
			})

			it("find and return the CVE from the database", func() {
				cve, err := mongoLibrary.FindCVE(ctx, mClient, "go")
				require.NoError(err)

				assert.Equal("golang", cve.Vendor)
				assert.Equal("go", cve.Product)
			})
		})

		context("fails", func() {
			context("decoding the CVE from the database", func() {
				it.Before(func() {
					mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

					mClient, ctx, err = mongoLibrary.GetMongoClient()
					require.NoError(err)
				})

				it("return an error", func() {
					_, err := mongoLibrary.FindCVE(ctx, mClient, "missing-product")
					require.Error(err)

					assert.EqualError(err, "mongo: no documents in result")
				})
			})
		})
	})

	context("Calls the RemoveAllCVEs method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)

				cves := []services.CVE{
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "haxx",
						Product:     "curl",
						Severity:    "CRITICAL",
						CVEId:       "TEST",
						Description: "TEST",
					},
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "golang",
						Product:     "go",
						Severity:    "HIGH",
						CVEId:       "TEST2",
						Description: "TEST2",
					},
					{
						ID:          primitive.NewObjectID(),
						CreatedAt:   time.Now(),
						UpdatedAt:   time.Now(),
						Vendor:      "haxx",
						Product:     "curl",
						Severity:    "LOW",
						CVEId:       "TEST3",
						Description: "TEST3",
					},
				}

				for _, cve := range cves {
					err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
					require.NoError(err)
				}
			})

			it("removes all CVEs of the given product", func() {
				err = mongoLibrary.RemoveAllCVEs(ctx, mClient, "curl")
				require.NoError(err)

				_, err := mongoLibrary.FindCVE(ctx, mClient, "curl")
				require.Error(err)

				assert.EqualError(err, "mongo: no documents in result")
			})
		})

		context("fails", func() {
			context("removing all CVEs of the given product when the context is exceeded", func() {
				it.Before(func() {
					mongoLibrary = services.MongoLibrary{
						DbUri:       mongoServer.URI(),
						CtxDuration: 1 * time.Nanosecond,
					}

					mClient, ctx, err = mongoLibrary.GetMongoClient()
					require.NoError(err)
				})

				it("return an error", func() {
					err = mongoLibrary.RemoveAllCVEs(ctx, mClient, "curl")
					require.Error(err)

					assert.Contains(err.Error(), "server selection error: context deadline exceeded")
				})
			})
		})
	})

	context("Calls the CVEExists method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary(mongoServer.URI())

				mClient, ctx, err = mongoLibrary.GetMongoClient()
				require.NoError(err)

				cve := services.CVE{
					ID:          primitive.NewObjectID(),
					CreatedAt:   time.Now(),
					UpdatedAt:   time.Now(),
					Vendor:      "golang",
					Product:     "go",
					Severity:    "LOW",
					CVEId:       "CVE-1",
					Description: "Test Description",
				}

				err = mongoLibrary.CreateCVE(ctx, mClient, &cve)
				require.NoError(err)
			})

			it("checks if the CVE with the given ID exists", func() {
				exists, err := mongoLibrary.CVEExists(ctx, mClient, "CVE-1")
				require.NoError(err)

				assert.Equal(true, exists)

				exists, err = mongoLibrary.CVEExists(ctx, mClient, "CVE-2")
				require.NoError(err)

				assert.Equal(false, exists)
			})
		})

		context("fails", func() {
			context("checking if the CVE with the given ID exists when the context is exceeded", func() {
				it.Before(func() {
					mongoLibrary = services.MongoLibrary{
						DbUri:       mongoServer.URI(),
						CtxDuration: 1 * time.Nanosecond,
					}

					mClient, ctx, err = mongoLibrary.GetMongoClient()
					require.NoError(err)
				})

				it("", func() {
					_, err := mongoLibrary.CVEExists(ctx, mClient, "CVE-1")
					require.Error(err)

					assert.Contains(err.Error(), "server selection error: context deadline exceeded")
				})
			})
		})
	})

	context("Calls the NewMongoLibrary method", func() {
		context("succeed", func() {
			it.Before(func() {
				mongoLibrary = services.NewMongoLibrary("some-uri")
			})

			it("returns a new MongoLibrary object with provided database URI", func() {
				assert.Equal(mongoLibrary.DbUri, "some-uri")
			})
		})
	})
}
